sh ./setups/deps

# Check for
echo "Installing packages with Composer..."
composer install

lando start

cd app
lando wp core download --locale=es_ES

# Check for
cd ..
composer install
#parche para reinstalar los plugins que johnpbloch/wordpress habrá borrado
composer update

cd app
# Extraer el directorio de WordPress de .lando.yml
WEBROOT=`grep webroot .lando.yml | cut -d: -f2 | xargs`

# Extraer los credenciales de la base de datos
DBNAME=`lando info --service database --format json | jq -r ".[0].creds.database"`
DBUSER=`lando info --service database --format json | jq -r ".[0].creds.user"`
DBPASS=`lando info --service database --format json | jq -r ".[0].creds.password"`
DBHOST=`lando info --service database --format json | jq -r ".[0].hostnames[0]"`

# Crear fichero de configuración de WordPress
lando wp config create \
  --dbname=$DBNAME \
  --dbuser=$DBUSER \
  --dbpass=$DBPASS \
  --dbhost=$DBHOST \
  --path=$WEBROOT
  
# Sacar el nombre del proyecto del fichero .lando.yml
PROJECT_NAME=`grep name .lando.yml | cut -d: -f2 | xargs`
SITE_NAME=`echo "$PROJECT_NAME" | sed -e "s/-/ /g" | sed "s/\b[a-z]/\u&/g"`

# Coger una URL para WordPress que no sea localhost y que sí use https
URL=`lando info --service appserver --format json | jq -r ".[0].urls" | grep -vw localhost | grep https: | cut -d'"' -f2`

# Ver el dominio que ha creado Lando (básicamente la URL sin el protocolo)
DOMAIN=`echo "$URL" | sed -e "s/^https:\/\///"`




# Instalar WordPress
lando wp core install
 --url=$URL
 --title="$SITE_NAME"
 --admin_user=admin
 --admin_password=password
 --admin_email=admin@$DOMAIN
 --path=$WEBROOT

echo

if [ $failures_flag -eq 1 ]; then
  printf "%s", "$failures_message"
  exit 1
fi

